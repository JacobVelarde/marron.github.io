<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <title>RA V13</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      #log {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.6);
        color: #00ff88;
        font-family: monospace;
        font-size: 14px;
        padding: 8px;
        max-height: 120px;
        overflow-y: auto;
        z-index: 9999;
      }
      html, body {
        margin: 0;
        overflow: hidden;
        background: #000;
        width: 100%;
        height: 100%;
        font-family: sans-serif;
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #000;
        color: #fff;
        font-size: 1.5em;
        text-align: center;
        padding: 20px;
        z-index: 20;
      }

      #scene-container {
        display: none;
        width: 100%;
        height: 100%;
      }

      #loading {
        display: none;
        background: rgba(0,0,0,0.7);
        font-size: 1em;
        color: #fff;
      }
    </style>

    <script>
      let mindarComponent = null;

      // Sistema de logs visibles
      function logMessage(msg) {
        const log = document.getElementById("log");
        const line = document.createElement("div");
        line.textContent = `> ${msg}`;
        log.appendChild(line);
        log.scrollTop = log.scrollHeight;
      }

      async function lockToLandscape() {
        logMessage("Validando orientacion")
        try {
          if (screen.orientation && screen.orientation.lock) {
            await screen.orientation.lock("landscape");
            logMessage("üîí Orientaci√≥n bloqueada en landscape");
          }
        } catch (e) {
          logMessage("No se pudo bloquear la orientaci√≥n:", e);
        }
      }

      function checkOrientation() {
        const alertBox = document.getElementById('rotate-alert');
        const sceneContainer = document.getElementById('scene-container');

        const isLandscape = window.innerWidth > window.innerHeight;

        if (isLandscape) {
            logMessage("is landscaoe")
            alertBox.style.display = 'none';
            sceneContainer.style.display = 'block';
            resumeCamera();
        } else {
            logMessage("ir portraite")
            alertBox.style.display = 'flex';
            sceneContainer.style.display = 'none';
            pauseCamera();
        }
      }

      function pauseCamera() {
        const scene = document.querySelector('#mindar-scene');
        if (scene && scene.components && scene.components['mindar-image']) {
          const mindar = scene.components['mindar-image'];
          if (mindar && mindar.isReady) {
            logMessage("‚è∏Ô∏è Pausando c√°mara...");
            mindar.stop();
          }
        }
      }

      function resumeCamera() {
        // La c√°mara se reanudar√° autom√°ticamente cuando la escena sea visible
        // y MindAR detecte que necesita iniciarse.
        // No es necesario llamar a start() manualmente en este flujo.
        logMessage("‚ñ∂Ô∏è Reanudando c√°mara...");
      }

      async function checkCameraPermission() {
        logMessage("Validando permisos de camera")
        const permissionAlert = document.getElementById('permission-alert');
        const loading = document.getElementById('loading');

        loading.style.display = 'flex';
        try {
          // Pedimos acceso a la c√°mara para verificar el permiso
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          logMessage("‚úÖ Permiso de c√°mara concedido");
          // Detenemos el stream inmediatamente, MindAR gestionar√° el suyo propio
          stream.getTracks().forEach(track => track.stop());
          
          permissionAlert.style.display = 'none';
          loading.style.display = 'none';
          checkOrientation();
        } catch (err) {
          logMessage("‚ùå Permiso de c√°mara denegado: " + err.message);
          loading.style.display = 'none';
          permissionAlert.style.display = 'flex';
        }
      }

      window.addEventListener('resize', checkOrientation);
      window.addEventListener('orientationchange', checkOrientation);

      window.addEventListener('load', async () => {
        logMessage("P√°gina cargada. Iniciando...");
        await lockToLandscape();
        await checkCameraPermission();

        const scene = document.querySelector('#mindar-scene');
        scene.addEventListener('loaded', () => {
          mindarComponent = scene.components['mindar-image'];
          logMessage("Escena de MindAR cargada.");
        });
      });

      AFRAME.registerComponent('marker-handler', {
        init: function() {
          const model = document.querySelector('#monk');
          
          this.el.addEventListener('targetFound', () => {
            logMessage("üéØ Marcador detectado");
            model.setAttribute('animation-mixer', '');
          });

          this.el.addEventListener('targetLost', () => {
            logMessage("‚ùå Marcador perdido");
            model.removeAttribute('animation-mixer');
          });
        }
      });

    </script>
  </head>

  <body style="margin: 0; overflow: hidden;">

    <div id="rotate-alert" class="overlay">
      üîÑ Gira tu dispositivo a modo horizontal (landscape)
    </div>

    <div id="permission-alert" class="overlay" style="display:none;">
      ‚ö†Ô∏è Necesitamos permiso para usar tu c√°mara<br><br>
      Ve a los ajustes del navegador y act√≠valo para continuar.
    </div>

    <!--<div id="loading" class="overlay">
      üì∑ Activando c√°mara... espera un momento
    </div>-->

    <div id="scene-container">
        <a-scene
        id="mindar-scene"
        mindar-image="imageTargetSrc: ./src/targets.mind; maxTrack: 1;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        embedded
        renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true;">
            <a-camera position="0 0 0"></a-camera>

            <a-entity mindar-image-target="targetIndex: 0" marker-handler>
                    <a-gltf-model 
                    id="monk"
                    src="./src/monk_character.glb"
                    scale="0.1 0.1 0.1"
                    position="0 0 0">
                    </a-gltf-model>
            </a-entity>
        </a-scene>
    </div>

    <div id="log">üì± Log de eventos RA</div>
  </body>
</html>